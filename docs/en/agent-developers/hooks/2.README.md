# Hooks System

The Agentrix hooks system allows you to intercept and customize agent behavior at critical lifecycle points.

## What are Hooks?

Hooks are TypeScript functions that execute at specific moments during agent execution. They enable you to:

- **Control tool execution**: Approve, deny, or modify tool calls before execution
- **Initialize repositories**: Set up files when creating new git repositories
- **Track sessions**: Monitor agent lifecycle events
- **Process results**: Inspect and transform tool outputs
- **Add custom logic**: Inject domain-specific behavior

## Quick Example

```typescript
import type { PreToolUseHookInput } from '@anthropic-ai/claude-agent-sdk';

export async function PreToolUse(
  input: PreToolUseHookInput,
  toolUseID: string,
  options: { signal: AbortSignal }
) {
  // Block destructive operations
  if (input.tool_name === 'Bash' &&
      input.tool_input?.command?.includes('rm -rf')) {
    return { decision: 'block', systemMessage: 'Destructive command blocked' };
  }

  return { decision: 'approve' };
}
```

## Available Hooks

Agentrix supports **12 hook types**:

### Claude SDK Hooks (11)

From `@anthropic-ai/claude-agent-sdk`:

1. **PreToolUse** - Before tool execution
2. **PostToolUse** - After tool execution
3. **SessionStart** - When agent session starts
4. **SessionEnd** - When agent session ends
5. **UserPromptSubmit** - When user submits a prompt
6. **Stop** - When agent stops
7. **SubagentStart** - When subagent starts
8. **SubagentStop** - When subagent stops
9. **PreCompact** - Before context compaction
10. **Notification** - System notifications
11. **PermissionRequest** - When permission is needed

### Agentrix Custom Hooks (1)

From `@agentrix/shared`:

12. **RepositoryInit** - When initializing new git repository

## Hook Documentation

### By Category

**Tool Control**:
- [PreToolUse & PostToolUse](5.pre-tool-use.md) - Control and monitor tool execution

**Session Lifecycle**:
- [Session Hooks](7.session-hooks.md) - SessionStart, SessionEnd, UserPromptSubmit, Stop, SubagentStop

**Repository Management**:
- [RepositoryInit](6.repository-init.md) - Initialize new repositories

**System Events**:
- [PreCompact](5.pre-tool-use.md#precompact) - Context management
- [Notification](5.pre-tool-use.md#notification) - System notifications

### Comprehensive Guides

- [Overview](1.overview.md) - Hook concepts and architecture
- [Development Guide](3.development-guide.md) - Setting up TypeScript project
- [Hook Types Reference](4.hook-types.md) - Complete type definitions
- [Examples](8.examples.md) - Real-world patterns

## Getting Started

### 1. Setup Hooks Project

```bash
mkdir -p claude/hooks/src
cd claude/hooks
```

Create `package.json`:

```json
{
  "name": "agent-hooks",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "build": "tsc",
    "dev": "tsc --watch"
  },
  "dependencies": {
    "@agentrix/shared": "latest"
  },
  "devDependencies": {
    "@anthropic-ai/claude-agent-sdk": "^0.1.30",
    "@types/node": "^20.0.0",
    "typescript": "^5.0.0"
  }
}
```

### 2. Install Dependencies

```bash
npm install
```

### 3. Create Hook

Create `src/index.ts`:

```typescript
import type { PreToolUseHookInput } from '@anthropic-ai/claude-agent-sdk';

export async function PreToolUse(
  input: PreToolUseHookInput,
  toolUseID: string,
  options: { signal: AbortSignal }
) {
  console.log(`[PreToolUse] ${input.tool_name}`);
  return { decision: 'approve' };
}
```

### 4. Build

```bash
npm run build
```

See [Development Guide](3.development-guide.md) for complete setup.

## Hook Execution Order

When an agent runs, hooks execute in this order:

```
1. SessionStart
   ↓
2. UserPromptSubmit (for each user message)
   ↓
3. PreToolUse (for each tool call)
   ↓
4. [Tool Executes]
   ↓
5. PostToolUse (for each tool result)
   ↓
6. PreCompact (if context limit reached)
   ↓
7. Stop / SessionEnd (when session ends)
```

Special hooks:
- **RepositoryInit**: Runs once during `git init` (before initial commit)
- **SubagentStop**: Runs when subagents complete
- **Notification**: Triggered by system events

## Common Patterns

### Security Control

```typescript
export async function PreToolUse(input: PreToolUseHookInput) {
  // Deny dangerous bash commands
  if (input.tool_name === 'Bash') {
    const cmd = input.tool_input?.command;
    if (cmd?.match(/rm -rf|dd if=|mkfs/)) {
      return { decision: 'deny', message: 'Unsafe command' };
    }
  }
  return { decision: 'approve' };
}
```

### Audit Logging

```typescript
import { appendFileSync } from 'fs';

export async function PostToolUse(input: PostToolUseHookInput) {
  const log = {
    timestamp: new Date().toISOString(),
    tool: input.tool_name,
    success: !input.tool_response?.error
  };

  appendFileSync('audit.log', JSON.stringify(log) + '\n');
  return {};
}
```

### Repository Setup

```typescript
import { appendFileSync } from 'fs';
import { join } from 'path';

export async function RepositoryInit(input: RepositoryInitHookInput) {
  // Add custom .gitignore rules
  const gitignorePath = join(input.workspace_path, '.gitignore');
  appendFileSync(gitignorePath, '\n.env\n*.log\n');

  return {};
}
```

See [Examples](8.examples.md) for more patterns.

## Type Safety

All hook types are available from `@agentrix/shared`:

```typescript
import type {
  // Tool hooks
  PreToolUseHookInput,
  PostToolUseHookInput,

  // Session hooks
  SessionStartHookInput,
  SessionEndHookInput,
  UserPromptSubmitHookInput,
  StopHookInput,
  SubagentStopHookInput,

  // System hooks
  PreCompactHookInput,
  NotificationHookInput,

  // Agentrix custom hooks
  RepositoryInitHookInput,
} from '@agentrix/shared';
```

## Best Practices

1. **Error Handling**: Hooks should never crash - wrap in try/catch
2. **Timeouts**: Hooks have 30s timeout - keep them fast
3. **Side Effects**: Be cautious with file system operations
4. **Logging**: Use console.log for debugging (visible in agent logs)
5. **Type Safety**: Always import types from `@agentrix/shared`

## Debugging Hooks

### Enable Verbose Logging

```bash
DEBUG=agentrix:hooks agentrix run --agent=./my-agent
```

### Check Hook Execution

```typescript
export async function PreToolUse(input: PreToolUseHookInput) {
  console.log('[DEBUG] PreToolUse called:', {
    tool: input.tool_name,
    input: input.tool_input
  });
  return { decision: 'approve' };
}
```

### Test Hook Locally

```typescript
// test/hook.test.ts
import { PreToolUse } from '../src/index';

const mockInput = {
  tool_name: 'Read',
  tool_input: { file_path: 'test.txt' }
};

const result = await PreToolUse(mockInput, 'test-id', {
  signal: new AbortController().signal
});

console.assert(result.decision === 'approve');
```

## Limitations

- Hooks run in isolated process (no shared state between hooks)
- 30 second timeout per hook
- Cannot modify agent's base system prompt
- Cannot add new tools (use MCP servers instead)

## Migration from Legacy Hooks

Old format:

```typescript
export function preToolUse(toolName: string, input: any) {
  // ...
}
```

New format:

```typescript
import type { PreToolUseHookInput } from '@anthropic-ai/claude-agent-sdk';

export async function PreToolUse(
  input: PreToolUseHookInput,
  toolUseID: string,
  options: { signal: AbortSignal }
) {
  // ...
}
```

## Next Steps

- [Development Guide](3.development-guide.md) - Set up TypeScript project
- [Hook Types Reference](4.hook-types.md) - All hook signatures
- [Examples](8.examples.md) - Copy-paste patterns
- [API Reference](../api-reference.md) - Complete type definitions

## Getting Help

- [GitHub Issues](https://github.com/agentrix/agentrix/issues)
- [Discord Community](https://discord.gg/agentrix)
- [Hook Examples Repository](https://github.com/agentrix/hook-examples)
